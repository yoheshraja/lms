<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard | Content Library</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="/style.css">
</head>
<body>

<div class="header">
    <div class="header-content">
        <div>Admin Dashboard</div>
        <div class="admin-info">
            <div class="admin-avatar">
                <i class="fas fa-user-shield"></i>
            </div>
            <div class="admin-details">
                <div class="admin-name">Admin User</div>
                <div class="admin-role">Content Manager</div>
            </div>
        </div>
    </div>
</div>

<div class="dashboard-container">
    <!-- Sidebar -->
    <div class="sidebar">
        <ul class="sidebar-menu">
            <li>
                <a href="/admin/upload" class="menu-item">
                    <i class="fas fa-upload"></i>
                    <span>Upload Content</span>
                </a>
            </li>

            <li>
                <a href="/admin/content-library" class="menu-item active">
                    <i class="fas fa-folder-open"></i>
                    <span>Content Library</span>
                </a>
            </li>

            <li>
                <a href="/admin/analytics" class="menu-item">
                    <i class="fas fa-chart-bar"></i>
                    <span>Analytics</span>
                </a>
            </li>

            <li>
                <a href="/admin/user-management" class="menu-item">
                    <i class="fas fa-users"></i>
                    <span>User Management</span>
                </a>
            </li>

            <li>
                <a href="/admin/settings" class="menu-item">
                    <i class="fas fa-cog"></i>
                    <span>Settings</span>
                </a>
            </li>
        </ul>
        
        <div class="logout btn btn-outline logout-btn" onclick="logout()">
            <i class="fas fa-sign-out-alt"></i>
            <span>Logout</span>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Content Library Header -->
        <div class="form-container">
            <div class="form-header">
                <div class="form-title">Content Library</div>
                <div class="form-grid cols-2 gap-15 no-margin-bottom">
                    <div class="form-group no-margin-bottom">
                        <input type="text" id="searchContent" placeholder="Search content..." onkeyup="handleSearch('searchContent', 'contentTable')">
                    </div>
                    <a href="/admin/upload" class="btn btn-primary">
                        <i class="fas fa-plus"></i>
                        <span>Add New</span>
                    </a>
                </div>
            </div>
        </div>

        <!-- Content Table -->
        <div class="data-table-container">
            <table class="data-table" id="contentTable">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Title</th>
                        <th>Topic</th>
                        <th>Description</th>
                        <th>Files</th>
                        <th>Created Date</th>
                        <th>Created By</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="contentTableBody">
                    <!-- Dynamic content will be loaded here -->
                </tbody>
            </table>
        </div>

        <!-- Loading State -->
        <div id="loadingState" class="loading-container">
            <div class="loader"></div>
            <p>Loading content...</p>
        </div>

        <!-- No Content State -->
        <div id="noContentState" class="no-content hidden-element" >
            <i class="fas fa-inbox fa-3x"></i>
            <h3>No Content Available</h3>
            <p>Get started by uploading your first piece of content.</p>
            <a href="/admin/upload" class="btn btn-primary">
                <i class="fas fa-upload"></i>
                <span>Upload Content</span>
            </a>
        </div>
    </div>
</div>

<!-- Edit Content Modal -->
<div id="editModal" class="modal hidden-element">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Edit Content</h3>
            <span class="close" onclick="closeEditModal()">&times;</span>
        </div>
        <div class="modal-body">
            <form id="editForm" enctype="multipart/form-data">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="editTitle">Content Title</label>
                        <input id="editTitle" name="title" type="text" required>
                    </div>
                    <div class="form-group">
                        <label for="editTopic">Topic</label>
                        <select id="editTopic" name="topic" required>
                            <option value="">Select a topic</option>
                            <option value="technology">Technology</option>
                            <option value="science">Science</option>
                            <option value="arts">Arts</option>
                            <option value="business">Business</option>
                            <option value="health">Health</option>
                        </select>
                    </div>
                    <div class="form-group full-width">
                        <label for="editDescription">Description</label>
                        <textarea id="editDescription" name="description" required></textarea>
                    </div>
                    
                    <!-- File Upload Sections -->
                    <div class="form-group">
                        <label>Current Image</label>
                        <div id="currentImagePreview" class="file-preview"></div>
                        <label>Upload New Image</label>
                        <div class="file-input-container">
                            <input id="editImage" name="image" type="file" accept="image/*">
                            <label for="editImage" class="file-input-label">
                                <i class="fas fa-image file-input-icon"></i>
                                <span class="file-input-text">Choose new image</span>
                            </label>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Current Audio</label>
                        <div id="currentAudioPreview" class="file-preview"></div>
                        <label>Upload New Audio</label>
                        <div class="file-input-container">
                            <input id="editAudio" name="audio" type="file" accept="audio/*">
                            <label for="editAudio" class="file-input-label">
                                <i class="fas fa-music file-input-icon"></i>
                                <span class="file-input-text">Choose new audio</span>
                            </label>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Current Video</label>
                        <div id="currentVideoPreview" class="file-preview"></div>
                        <label>Upload New Video</label>
                        <div class="file-input-container">
                            <input id="editVideo" name="video" type="file" accept="video/*">
                            <label for="editVideo" class="file-input-label">
                                <i class="fas fa-video file-input-icon"></i>
                                <span class="file-input-text">Choose new video</span>
                            </label>
                        </div>
                    </div>
                </div>
                
                <div class="action-buttons">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i>
                        <span>Update Content</span>
                    </button>
                    <button type="button" class="btn btn-outline" onclick="closeEditModal()">
                        <i class="fas fa-times"></i>
                        <span>Cancel</span>
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script src="/script.js"></script>
<script>
// Load content when page loads
document.addEventListener('DOMContentLoaded', function() {
    loadContentLibrary();
});

// Load content from backend
async function loadContentLibrary() {
    const token = localStorage.getItem('token');
    if (!token) {
        window.location.href = '/login';
        return;
    }

    try {
        showLoadingState();
        
        const response = await fetch('/get-contents', {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });

        if (response.ok) {
            const contents = await response.json();
            displayContents(contents);
        } else {
            throw new Error('Failed to fetch content');
        }
    } catch (error) {
        console.error('Error loading content:', error);
        showError('Failed to load content: ' + error.message);
        showNoContentState();
    }
}

// Display contents in table
function displayContents(contents) {
    const tableBody = document.getElementById('contentTableBody');
    const loadingState = document.getElementById('loadingState');
    const noContentState = document.getElementById('noContentState');

    // Hide loading state
    loadingState.style.display = 'none';

    if (!contents || contents.length === 0) {
        showNoContentState();
        return;
    }

    // Hide no content state
    noContentState.style.display = 'none';

    // Clear existing content
    tableBody.innerHTML = '';

    // Add each content item to the table
    contents.forEach(content => {
        const row = document.createElement('tr');
        
        // Format date
        const createdDate = new Date(content.created_at).toLocaleDateString();
        
        // Determine available files
        const files = [];
        if (content.image) files.push('Image');
        if (content.audio) files.push('Audio');
        if (content.video) files.push('Video');
        const fileTypes = files.length > 0 ? files.join(', ') : 'No files';

        row.innerHTML = `
            <td>${content.id}</td>
            <td class="content-title">${content.title}</td>
            <td><span class="content-topic">${content.topic}</span></td>
            <td class="content-description">${content.description || 'No description'}</td>
            <td>${fileTypes}</td>
            <td>${createdDate}</td>
            <td>${content.created_by}</td>
            <td>
                <div class="content-actions">
                    <button class="action-btn" aria-label="Edit item" title="Edit" onclick="openEditModal(${content.id})">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="action-btn" aria-label="Delete item" title="Delete" onclick="deleteContent(${content.id})">
                        <i class="fas fa-trash"></i>
                    </button>
                    <button class="action-btn" aria-label="View item" title="View" onclick="viewContent(${content.id})">
                        <i class="fas fa-eye"></i>
                    </button>
                </div>
            </td>
        `;
        
        tableBody.appendChild(row);
    });
}

// Open edit modal
async function openEditModal(contentId) {
    const token = localStorage.getItem('token');
    if (!token) return;

    try {
        const response = await fetch(`/get-content/${contentId}`, {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });

        if (response.ok) {
            const content = await response.json();
            populateEditForm(content);
            document.getElementById('editModal').style.display = 'block';
        } else {
            throw new Error('Failed to fetch content details');
        }
    } catch (error) {
        console.error('Error loading content details:', error);
        showError('Failed to load content details: ' + error.message);
    }
}

// Populate edit form with content data
function populateEditForm(content) {
    document.getElementById('editTitle').value = content.title;
    document.getElementById('editTopic').value = content.topic;
    document.getElementById('editDescription').value = content.description || '';
    
    // Set current content ID for form submission
    document.getElementById('editForm').dataset.contentId = content.id;

    // Display current files
    displayFilePreview('currentImagePreview', content.image, 'image');
    displayFilePreview('currentAudioPreview', content.audio, 'audio');
    displayFilePreview('currentVideoPreview', content.video, 'video');
}

// Display file preview
function displayFilePreview(containerId, filename, fileType) {
    const container = document.getElementById(containerId);
    if (filename) {
        const fileUrl = `/uploads/${filename}`;
        let previewHtml = '';
        
        if (fileType === 'image') {
            previewHtml = `<img src="${fileUrl}" alt="Current image" style="max-width: 100px; max-height: 100px; border-radius: 4px;">`;
        } else {
            previewHtml = `<div class="file-preview-item">
                <i class="fas fa-file ${fileType === 'audio' ? 'fa-music' : 'fa-video'}"></i>
                <span>${filename}</span>
                <a href="${fileUrl}" target="_blank" class="btn-link">View</a>
            </div>`;
        }
        
        container.innerHTML = previewHtml;
    } else {
        container.innerHTML = '<span class="no-file">No file uploaded</span>';
    }
}

// Close edit modal
function closeEditModal() {
    document.getElementById('editModal').style.display = 'none';
    document.getElementById('editForm').reset();
}

// Handle edit form submission
document.getElementById('editForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const contentId = this.dataset.contentId;
    const token = localStorage.getItem('token');
    if (!token) return;

    const formData = new FormData(this);

    try {
        const response = await fetch(`/update-content/${contentId}`, {
            method: 'PUT',
            headers: {
                'Authorization': `Bearer ${token}`
            },
            body: formData
        });

        if (response.ok) {
            closeEditModal();
            loadContentLibrary();
            showSuccess('Content updated successfully!');
        } else {
            throw new Error('Failed to update content');
        }
    } catch (error) {
        console.error('Error updating content:', error);
        showError('Failed to update content: ' + error.message);
    }
});

// Delete content
async function deleteContent(contentId) {
    if (!confirm('Are you sure you want to delete this content? This action cannot be undone.')) {
        return;
    }

    const token = localStorage.getItem('token');
    if (!token) return;

    try {
        const response = await fetch(`/delete-content/${contentId}`, {
            method: 'DELETE',
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });

        if (response.ok) {
            loadContentLibrary();
            showSuccess('Content deleted successfully!');
        } else {
            throw new Error('Failed to delete content');
        }
    } catch (error) {
        console.error('Error deleting content:', error);
        showError('Failed to delete content: ' + error.message);
    }
}

// View content (open in new tab if file exists)
function viewContent(contentId) {
    // For now, just open the edit modal
    openEditModal(contentId);
}

// Show loading state
function showLoadingState() {
    document.getElementById('loadingState').style.display = 'block';
    document.getElementById('noContentState').style.display = 'none';
}

// Show no content state
function showNoContentState() {
    document.getElementById('loadingState').style.display = 'none';
    document.getElementById('noContentState').style.display = 'block';
    document.getElementById('contentTableBody').innerHTML = '';
}

// Show success message
function showSuccess(message) {
    alert('Success: ' + message); // Replace with better notification system
}

// Show error message
function showError(message) {
    alert('Error: ' + message); // Replace with better notification system
}
</script>
</body>
</html>